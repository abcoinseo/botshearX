<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bot Market Mini App</title>
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Telegram WebApp JS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* Basic Reset & Font */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e; /* Slightly lighter for cards */
            --primary-color: #bb86fc; /* Purple */
            --secondary-color: #03dac6; /* Teal */
            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --text-on-primary: #000000;
            --error-color: #cf6679;
            --border-color: #333333;
            --hover-overlay: rgba(255, 255, 255, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica,
                Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overscroll-behavior: none;
            height: 100vh; /* Use 100vh for mobile view */
            display: flex;
            flex-direction: column;
            font-size: 16px; /* Base font size */
            line-height: 1.5;
        }

        #app {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Page Structure & Transitions --- */
        .page {
            display: none; /* Hide pages by default */
            flex-grow: 1;
            overflow-y: auto; /* Allow scrolling within the page */
            padding: 15px;
            padding-bottom: 85px; /* Increased space for taller nav */
            flex-direction: column;
            opacity: 0;
            transform: translateX(10px); /* Start slightly off-screen */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            background-color: var(--bg-color); /* Ensure background */
            position: absolute; /* Needed for smooth transition */
            top: 0; left: 0; width: 100%; height: 100%;
        }

        .page.active-page {
            display: flex;
            opacity: 1;
            transform: translateX(0);
            position: relative; /* Take up space */
            z-index: 1; /* Ensure active page is visually on top */
        }

        /* Style for elements that look like cards */
        .card-style {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        header {
            margin-bottom: 10px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0; /* Prevent header shrinking */
        }
        #bot-detail-page header, #chat-page header {
            padding-bottom: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        #bot-detail-page header { justify-content: flex-start; }
        #chat-page header { justify-content: center; }


        h1 {
            font-size: 1.6em;
            font-weight: 600;
            color: #fff;
        }
        h2 {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-top: 10px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
        }

        main {
           flex-grow: 1;
           overflow-y: auto; /* Allow main content to scroll if needed */
           padding-bottom: 10px; /* Space at the bottom */
        }
        /* Remove main padding for pages where content should fill */
        #home-page main, #profile-page main, #chat-page main {
            padding: 0;
        }

        /* --- Loading Screen --- */
        #loading-screen {
            display: flex; /* Initially visible */
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 500; /* High z-index */
            opacity: 1;
            background-color: var(--bg-color);
            flex-direction: column;
            transition: opacity 0.5s ease-out; /* Fade out transition */
        }
        #loading-screen.hidden { /* Class to fade out and hide */
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }

        .spinner { /* Use primary color */
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* --- Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--surface-color);
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            z-index: 100;
            box-shadow: 0 -2px 5px var(--shadow-color);
            padding: 5px 0; /* Add some vertical padding */
            flex-shrink: 0; /* Prevent nav shrinking */
        }

        .nav-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 8px 5px; /* Adjusted padding */
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem; /* Smaller text */
            flex-grow: 1;
            transition: color 0.2s ease, transform 0.1s ease;
            position: relative; /* For potential active indicator */
            outline: none; /* Remove focus outline */
            line-height: 1.2;
        }
        .nav-button:active {
            transform: scale(0.95); /* Click feedback */
        }

        .nav-button span.material-symbols-outlined {
            font-size: 26px; /* Slightly larger icons */
            margin-bottom: 2px;
        }

        .nav-button.active {
            color: var(--primary-color);
        }
        .nav-button.add-button span.material-symbols-outlined {
            font-size: 34px;
            color: var(--secondary-color);
        }


        /* --- Buttons (General Styling) --- */
        .button {
            padding: 10px 20px;
            border-radius: 25px; /* Pill shape */
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            transition: background-color 0.2s ease, opacity 0.2s ease, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase; /* Optional */
            letter-spacing: 0.5px; /* Optional */
            outline: none;
            line-height: 1.2; /* Ensure text vertical alignment */
        }
        .button:active {
            transform: scale(0.97); /* Click feedback */
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #555 !important; /* Ensure disabled state is clear */
            color: #999 !important;
            transform: none !important;
        }

        .button.primary-button, .boost-option {
            background-color: var(--primary-color);
            color: var(--text-on-primary);
        }
        .button.primary-button:hover:not(:disabled), .boost-option:hover:not(:disabled) {
            background-color: #a874e8; /* Darker primary */
        }

        .button.secondary-button {
            background-color: var(--secondary-color);
            color: var(--text-on-primary);
        }
        .button.secondary-button:hover:not(:disabled) {
            background-color: #00bfa5; /* Darker secondary */
        }

        .cancel-button, .button.default-button {
            background-color: #444;
            color: var(--text-secondary);
        }
        .cancel-button:hover:not(:disabled), .button.default-button:hover:not(:disabled) {
            background-color: #555;
            color: var(--text-primary);
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            outline: none;
        }
        .icon-button:hover:not(:disabled) {
            background-color: var(--hover-overlay);
            color: var(--text-primary);
        }
        .icon-button span.material-symbols-outlined {
            font-size: 24px;
        }
        #back-to-home-button span.material-symbols-outlined { font-size: 28px; }


        /* --- Forms --- */
        label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        input[type="text"],
        input[type="url"],
        input[type="number"],
        textarea {
            display: block;
            width: 100%;
            background-color: var(--bg-color); /* Darker input background */
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(187, 134, 252, 0.3); /* Focus ring */
        }
        textarea { resize: vertical; min-height: 80px;}
        label[for="bot-active"] {
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--text-primary); cursor: pointer;
        }
        input[type="checkbox"] { width: auto; margin-bottom: 0; accent-color: var(--primary-color); height: 18px; width: 18px; cursor: pointer;}


        /* --- Home Page Specifics --- */
        #home-page .search-container { /* Scoped to home page */
            display: flex;
            align-items: center;
            background-color: var(--surface-color);
            padding: 8px 12px;
            border-radius: 25px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }
        .search-container span { margin-right: 8px; color: var(--text-secondary); }
        #search-input { background: none; border: none; color: var(--text-primary); outline: none; flex-grow: 1; padding: 0; margin: 0; font-size: 1em; }
        #search-input::placeholder { color: #777; }

        .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0;}
        .tab-button {
            background: none; border: none; color: var(--text-secondary); padding: 12px 18px; cursor: pointer; font-size: 0.9em; font-weight: 500; border-bottom: 3px solid transparent; transition: color 0.2s ease, border-color 0.2s ease; flex-shrink: 0; white-space: nowrap;
        }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        #bot-list-container { padding: 0 15px; /* Add padding here since main has 0 */}

        /* Bot Card */
        .bot-card { /* Now uses .card-style */
            display: flex;
            gap: 15px;
            cursor: pointer;
            position: relative; /* For action buttons */
            transition: background-color 0.2s ease;
            overflow: hidden; /* Prevent content spillover */
        }
        .bot-card:hover { background-color: rgba(255, 255, 255, 0.05); } /* Subtle hover */

        .bot-card img.bot-image {
            width: 55px; height: 55px; border-radius: 10px; /* Squarish */ object-fit: cover; background-color: #444; flex-shrink: 0; border: 1px solid var(--border-color);
        }
        .bot-info { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center;}
        .bot-info h3 {
            color: #fff; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 5px;
        }
        .bot-info h3 span.material-symbols-outlined { /* Boost Icon */ font-size: 1.1em; color: #ffeb3b; vertical-align: middle; }
        .bot-info h3 span.inactive-tag { color: #ff9800; font-size: 0.8em; font-weight: normal; background-color: rgba(255, 152, 0, 0.2); padding: 2px 5px; border-radius: 4px; }
        .bot-info p.description {
            font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4;
        }
        .bot-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: var(--text-secondary); margin-top: auto; /* Pushes meta to bottom */ }
        .bot-meta .likes, .bot-meta .submitter { display: flex; align-items: center; gap: 5px; }
        .bot-meta button.like-button { background: none; border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; padding: 4px; border-radius: 50%; transition: color 0.2s ease, background-color 0.2s ease; }
        .bot-meta button.like-button:hover:not(:disabled) { background-color: var(--hover-overlay); }
        .bot-meta button.like-button.liked { color: var(--error-color); /* Red for liked */ }
        .bot-meta button.like-button .material-symbols-outlined { font-size: 20px; }
        .bot-meta .submitter span.material-symbols-outlined { font-size: 16px; }
        .bot-meta .like-count, .bot-meta .submitter span { white-space: nowrap; } /* Prevent wrapping */

        .placeholder { color: var(--text-secondary); text-align: center; margin-top: 30px; font-style: italic; width: 100%; padding: 20px; }

        /* Profile Page */
        #profile-page #my-bots-list { padding: 0 15px; } /* Add padding here */
        .profile-info { /* Uses .card-style */ margin-bottom: 25px; margin-left: 15px; margin-right: 15px; }
        .profile-info p { margin-bottom: 12px; line-height: 1.6; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px;}
        .profile-info strong { color: var(--text-secondary); margin-right: 10px; }
        .profile-info span { color: #fff; font-weight: 500; word-break: break-all; /* For long IDs/usernames */ }
        #profile-points { font-weight: bold; color: var(--secondary-color); font-size: 1.3em; }
        #profile-earn-ads-button { width: 100%; margin-top: 15px; background-color: var(--secondary-color); color: var(--text-on-primary);} /* Teal button */
        #my-bots-list .bot-card { margin-bottom: 10px; padding-right: 50px; /* Space for buttons */ }
        .bot-actions { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 8px; }
        .bot-actions button.icon-button { background-color: rgba(0, 0, 0, 0.4); border: 1px solid #555; color: var(--text-secondary); width: 36px; height: 36px; padding: 0; }
        .bot-actions button.icon-button:hover:not(:disabled) { background-color: rgba(0, 0, 0, 0.7); color: #fff; }
        .bot-actions button.icon-button .material-symbols-outlined { font-size: 18px; }

        /* --- Popups --- */
        .popup {
            display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 200; justify-content: center; align-items: center; padding: 15px; opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .popup.active-popup { display: flex; opacity: 1; }
        .popup-content {
            background-color: var(--surface-color); padding: 25px; border-radius: 12px; max-width: 500px; width: 100%; position: relative; max-height: 85vh; overflow-y: auto; box-shadow: 0 5px 15px var(--shadow-color); border: 1px solid var(--border-color); transform: scale(0.95); transition: transform 0.3s ease-out;
        }
        .active-popup .popup-content { transform: scale(1); }
        .popup-content h2 { color: #fff; margin-bottom: 20px; text-align: center; font-weight: 600; }
        .close-popup { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; line-height: 1; padding: 5px; border-radius: 50%; transition: color 0.2s, background-color 0.2s; }
        .close-popup:hover { color: #fff; background-color: var(--hover-overlay); }

        /* Boost Popup */
        .boost-options { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .boost-option { width: 100%; /* Uses .button style now */ }
        #boost-status { text-align: center; font-size: 0.9em; margin-top: 15px; min-height: 1.2em; color: var(--text-primary); }

        /* --- FAB --- */
        .fab-like {
            position: fixed; bottom: 95px; right: 20px; background-color: var(--secondary-color); color: var(--text-on-primary); border-radius: 50%; width: 56px; height: 56px; box-shadow: 0 4px 12px var(--shadow-color); z-index: 99; padding: 0; font-size: 0.7rem; line-height: 1.1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; cursor: pointer; transition: background-color 0.2s, transform 0.2s ease; outline: none;
        }
        .fab-like:hover:not(:disabled) { background-color: #00bfa5; transform: scale(1.05); }
        .fab-like:active:not(:disabled) { transform: scale(0.95); }
        .fab-like span.material-symbols-outlined { font-size: 24px; margin: 0 0 2px 0; }


        /* --- Bot Detail Page --- */
        #bot-detail-page main { /* Overriding main general padding */
           overflow-y: visible; /* Allow content to flow */
           padding: 0;
        }
        #bot-detail-content { /* Uses card-style */ padding: 20px; margin: 0 15px 15px 15px; /* Add margins */ }
        #bot-detail-content img { max-width: 100px; max-height: 100px; border-radius: 12px; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; border: 1px solid var(--border-color); }
        #detail-description { margin-bottom: 20px; line-height: 1.6; color: var(--text-primary); white-space: pre-wrap; /* Preserve line breaks */ }
        #detail-meta p { margin-bottom: 10px; font-size: 0.9em; color: var(--text-secondary); display: flex; align-items: flex-start; gap: 8px; }
        #detail-meta strong { color: var(--text-primary); min-width: 90px; display: inline-block; flex-shrink: 0;}
        #detail-meta span, #detail-meta a { color: var(--text-primary); word-break: break-all; }
        #detail-meta a { color: var(--primary-color); text-decoration: none; }
        #detail-meta a:hover { text-decoration: underline; }
        #detail-like-section { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; }
        #detail-like-button { /* Uses .button base style */ padding: 8px 15px; border-radius: 20px; font-size: 0.9em; min-width: 100px; text-align: center; }
        #detail-like-button.liked { background-color: var(--error-color); color: #fff; }
        #detail-like-button:not(.liked) { background-color: #444; color: var(--text-secondary); }
        #detail-like-button .material-symbols-outlined { font-size: 20px; margin-right: 5px; vertical-align: bottom;}
        #detail-like-count { font-size: 1em; color: var(--text-primary); font-weight: 500; }

        /* --- Comments Section --- */
        #comments-section { /* Uses card-style */ margin: 0 15px 15px 15px; padding-bottom: 10px; }
        #comments-list { margin-bottom: 20px; max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .comment-card {
            background-color: var(--bg-color); /* Slightly darker than card */
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 5px;}
        .comment-author { font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 6px; font-size: 0.9em;}
        .comment-author span.material-symbols-outlined { font-size: 16px; color: var(--secondary-color); } /* Owner Icon */
        .comment-timestamp { font-size: 0.75em; color: var(--text-secondary); flex-shrink: 0;}
        .comment-text { font-size: 0.95em; color: var(--text-primary); line-height: 1.5; white-space: pre-wrap; /* Preserve formatting */ word-wrap: break-word; }
        /* Basic reply styling - More advanced nesting/threading possible */
        .comment-card.is-reply { margin-left: 20px; /* Indent replies */ }

        #add-comment-form textarea { margin-bottom: 10px; min-height: 60px; }
        #add-comment-form button { width: 100%; }


        /* --- Chat Page --- */
        #chat-page { display: flex; flex-direction: column; /* Ensure header/form don't scroll */ padding: 0;}
        #chat-page header { margin: 0 15px; padding-top: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);}
        #chat-page main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0; /* Main padding removed for full height chat area */}
        #chat-messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 15px; /* Padding inside the scrollable area */
            display: flex;
            flex-direction: column-reverse; /* Newest messages at the bottom */
        }
        #chat-messages { display: flex; flex-direction: column; gap: 12px; width: 100%;}

        .chat-message {
            padding: 8px 14px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative; /* For timestamp */
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .chat-message.sent {
            background-color: var(--primary-color);
            color: var(--text-on-primary);
            border-bottom-right-radius: 5px; /* Bubble tail */
            margin-left: auto;
            align-self: flex-end;
        }
        .chat-message.received {
            background-color: var(--surface-color);
            color: var(--text-primary);
            border-bottom-left-radius: 5px; /* Bubble tail */
            margin-right: auto;
            align-self: flex-start;
        }
        .message-sender {
            font-weight: 600;
            font-size: 0.8em;
            margin-bottom: 3px;
            display: block;
            color: rgba(255, 255, 255, 0.7); /* Lighter sender name */
        }
        .chat-message.sent .message-sender {
            color: rgba(0, 0, 0, 0.7); /* Darker sender name on primary */
        }
        .message-text { font-size: 1em; line-height: 1.4; }
        .message-timestamp {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
            text-align: right;
            display: block;
            margin-left: 8px; /* Space text from timestamp */
        }
        .chat-message.sent .message-timestamp { color: rgba(0, 0, 0, 0.5); }

        #chat-form {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            gap: 10px;
            flex-shrink: 0; /* Prevent form shrinking */
        }
        #chat-input {
            flex-grow: 1;
            margin-bottom: 0; /* Override default margin */
            padding: 10px 15px; /* Slightly smaller padding */
            border-radius: 20px; /* Rounded input */
            min-height: 44px; /* Match button height */
        }
        #chat-form .icon-button {
            width: 44px; height: 44px; flex-shrink: 0;
        }
        #chat-form .send-button {
            background-color: var(--primary-color);
            color: var(--text-on-primary);
        }
        #chat-form .send-button:hover:not(:disabled) {
            background-color: #a874e8;
        }
        /* #chat-form .points-button { color: var(--secondary-color); } */


        /* Number Formatting Helper Class */
        .points-display::after { content: ''; /* No suffix by default */ }
        .boost-option .points-display::after { content: ' Pts'; } /* Suffix in boost options */
        #detail-meta .points-display::after { content: ' pts'; } /* Suffix in airdrop */

        /* Utility */
        .hidden { display: none !important; }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen" class="page"> <!-- Start visible -->
            <div class="spinner"></div>
            <p>Loading App...</p>
            <p id="error-message" style="color: var(--error-color); display: none; margin-top: 15px;"></p>
        </div>

        <!-- Home Page -->
        <div id="home-page" class="page">
             <header>
                <h1>Bot Market</h1>
                <div class="search-container">
                    <span class="material-symbols-outlined">search</span>
                    <input type="text" id="search-input" placeholder="Search bots...">
                </div>
            </header>
            <div class="tabs">
                <button class="tab-button active" data-tab="all">All Bots</button>
                <button class="tab-button" data-tab="trending">Trending</button>
                <button class="tab-button" data-tab="top-liked">Top Liked</button>
            </div>
            <main id="bot-list-container">
                <!-- Bot cards will be loaded here -->
                <p class="placeholder">Loading bots...</p>
            </main>
             <!-- FAB for Earning Points -->
            <button id="home-earn-ads-button" class="fab-like" title="Earn Points by Watching Ads">
                <span class="material-symbols-outlined">paid</span>
                <span class="visually-hidden">Earn Points</span> <!-- Accessibility -->
            </button>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page">
            <header>
                <h1>Profile</h1>
            </header>
            <main>
                <div class="profile-info card-style">
                    <p><strong>Name:</strong> <span id="profile-name">...</span></p>
                    <p><strong>Username:</strong> <span id="profile-username">...</span></p>
                    <p><strong>Chat ID:</strong> <span id="profile-chat-id">...</span></p>
                    <p><strong>Points:</strong> <span id="profile-points" class="points-display">0</span></p>
                    <button id="profile-earn-ads-button" class="button secondary-button">
                        <span class="material-symbols-outlined">ads_click</span> Earn Points (Ad)
                    </button>
                 </div>
                <h2>My Submitted Bots</h2>
                <div id="my-bots-list">
                    <p class="placeholder">You haven't added any bots yet.</p>
                </div>
            </main>
        </div>

         <!-- Bot Detail Page -->
        <div id="bot-detail-page" class="page">
             <header>
                <button id="back-to-home-button" class="icon-button" title="Back"><span class="material-symbols-outlined">arrow_back</span></button>
                <h1 id="detail-bot-name">Bot Details</h1>
            </header>
            <main> <!-- Main will contain content and comments section -->
                <div id="bot-detail-content" class="card-style">
                    <!-- Bot details loaded here by JS -->
                    <p class="placeholder">Loading bot details...</p>
                </div>
                <section id="comments-section" class="card-style">
                    <h2>Comments</h2>
                    <div id="comments-list">
                        <p class="placeholder">Loading comments...</p>
                        <!-- Comments will be loaded here -->
                    </div>
                    <form id="add-comment-form">
                        <textarea id="comment-input" placeholder="Add your comment..." rows="3" required></textarea>
                        <button type="submit" class="button primary-button">
                            <span class="material-symbols-outlined">send</span> Post Comment
                        </button>
                    </form>
                </section>
            </main>
        </div>

        <!-- Chat Page -->
        <div id="chat-page" class="page">
            <header>
                <h1>Global Chat</h1>
            </header>
            <main id="chat-messages-container">
                <div id="chat-messages">
                    <p class="placeholder">Loading messages...</p>
                    <!-- Chat messages appear here -->
                </div>
            </main>
            <form id="chat-form">
                 <input type="text" id="chat-input" placeholder="Type your message..." required autocomplete="off">
                 <button type="submit" class="icon-button send-button" title="Send Message">
                     <span class="material-symbols-outlined">send</span>
                 </button>
                 <!-- Secure Point Sending Requires Cloud Function -->
                 <!-- <button type="button" id="send-points-button" class="icon-button points-button" title="Send Points (Requires Cloud Function)">
                     <span class="material-symbols-outlined">paid</span>
                 </button> -->
            </form>
        </div>

        <!-- Navigation -->
        <nav class="bottom-nav">
            <button data-page="home-page" class="nav-button active" title="Home">
                <span class="material-symbols-outlined">home</span>
                <span>Home</span>
            </button>
            <button id="add-bot-nav-button" class="nav-button add-button" title="Add Bot">
                <span class="material-symbols-outlined">add_circle</span>
                <span>Add Bot</span>
            </button>
            <button data-page="chat-page" class="nav-button" title="Chat">
                <span class="material-symbols-outlined">chat_bubble</span>
                <span>Chat</span>
            </button>
            <button data-page="profile-page" class="nav-button" title="Profile">
                <span class="material-symbols-outlined">person</span>
                <span>Profile</span>
            </button>
        </nav>

        <!-- Popups -->
        <div id="add-bot-popup" class="popup">
            <div class="popup-content">
                <span class="close-popup" data-popup="add-bot-popup" title="Close">&times;</span>
                <h2>Add New Bot</h2>
                <form id="add-bot-form">
                    <input type="hidden" id="edit-bot-id">
                    <label for="bot-name">Bot Name *</label>
                    <input type="text" id="bot-name" required>
                    <label for="bot-description">Description *</label>
                    <textarea id="bot-description" rows="3" required></textarea>
                    <label for="bot-link">Bot Link (t.me/...) *</label>
                    <input type="url" id="bot-link" required placeholder="https://t.me/YourBotUsername">
                    <label for="bot-image">Image Link (Optional)</label>
                    <input type="url" id="bot-image" placeholder="https://...">
                    <label for="bot-community">Telegram Community (Optional)</label>
                    <input type="url" id="bot-community" placeholder="https://t.me/YourGroupOrChannel">
                    <label for="bot-airdrop-name">Airdrop Name (Optional)</label>
                    <input type="text" id="bot-airdrop-name">
                    <label for="bot-airdrop-points">Airdrop Points (Optional)</label>
                    <input type="number" id="bot-airdrop-points" placeholder="e.g., 100">
                    <label for="bot-active">
                        <input type="checkbox" id="bot-active" checked> Make Active (Visible)?
                    </label>
                    <button type="submit" id="submit-bot-button" class="button primary-button">Add Bot</button>
                    <button type="button" class="cancel-button button" data-popup="add-bot-popup">Cancel</button>
                </form>
            </div>
        </div>

        <div id="boost-popup" class="popup">
             <div class="popup-content">
                 <span class="close-popup" data-popup="boost-popup" title="Close">&times;</span>
                 <h2>Boost Bot</h2>
                 <p>Make your bot appear in the Trending section!</p>
                 <input type="hidden" id="boost-bot-id">
                 <div class="boost-options">
                     <!-- Text updated dynamically by JS -->
                     <button class="boost-option button" data-duration="1" data-cost="1000">Boost 1 Day (<span class="points-display">1K</span>)</button>
                     <button class="boost-option button" data-duration="2" data-cost="2000">Boost 2 Days (<span class="points-display">2K</span>)</button>
                     <button class="boost-option button" data-duration="7" data-cost="10000">Boost 1 Week (<span class="points-display">10K</span>)</button>
                 </div>
                 <p id="boost-status" style="margin-top: 15px; min-height: 1.2em;"></p>
                 <button type="button" class="cancel-button button" data-popup="boost-popup">Cancel</button>
            </div>
        </div>

        <div id="info-popup" class="popup">
            <div class="popup-content">
                <span class="close-popup" data-popup="info-popup" title="Close">&times;</span>
                <h2 id="info-popup-title">Info</h2>
                <p id="info-popup-message" style="text-align: center; margin-bottom: 20px;"></p>
                <button type="button" class="cancel-button button" data-popup="info-popup">OK</button>
            </div>
        </div>

    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Ad Network SDK -->
    <script src='//whephiwums.com/sdk.js' data-zone='9263144' data-sdk='show_9263144'></script>

    <!-- Your App Logic -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBW1WPXUN8DYhT6npZQYoQ3l4J-jFSbzfg", // Replace if needed, but USE RULES!
            authDomain: "ab-studio-marketcap.firebaseapp.com",
            databaseURL: "https://ab-studio-marketcap-default-rtdb.firebaseio.com",
            projectId: "ab-studio-marketcap",
            storageBucket: "ab-studio-marketcap.firebasestorage.app",
            messagingSenderId: "115268088088",
            appId: "1:115268088088:web:65643a047f92bfaa66ee6d"
        };

        // --- Global Variables ---
        let tg = window.Telegram.WebApp;
        let db;
        let currentUser = null;
        let userProfile = { points: 0, likedBots: {}, lastAdWatch: 0 };
        let allBots = {};
        let currentBotList = [];
        let currentOpenBotId = null;
        let currentEditBotId = null;
        const LIKE_REWARD_POINTS = 10;
        const AD_REWARD_POINTS = 10;
        const AD_COOLDOWN_MS = 30 * 1000; // 30 seconds
        const CHAT_MESSAGE_LIMIT = 50;

        // Firebase Listeners References
        let botsListenerRef = null;
        let commentsListenerRef = null;
        let chatListenerRef = null;

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const errorMessage = document.getElementById('error-message');
        const appDiv = document.getElementById('app'); // Main container
        const pages = document.querySelectorAll('.page:not(#loading-screen)'); // Exclude loading screen
        const navButtons = document.querySelectorAll('.nav-button:not(.add-button)');
        const addBotNavButton = document.getElementById('add-bot-nav-button');
        const botListContainer = document.getElementById('bot-list-container');
        const searchInput = document.getElementById('search-input');
        const tabButtons = document.querySelectorAll('.tab-button');
        const profileName = document.getElementById('profile-name');
        const profileUsername = document.getElementById('profile-username');
        const profileChatId = document.getElementById('profile-chat-id');
        const profilePoints = document.getElementById('profile-points');
        const myBotsList = document.getElementById('my-bots-list');
        const homeEarnAdsButton = document.getElementById('home-earn-ads-button');
        const profileEarnAdsButton = document.getElementById('profile-earn-ads-button');
        const addBotPopup = document.getElementById('add-bot-popup');
        const boostPopup = document.getElementById('boost-popup');
        const infoPopup = document.getElementById('info-popup');
        const addBotForm = document.getElementById('add-bot-form');
        const closePopupButtons = document.querySelectorAll('.close-popup, .cancel-button[data-popup]');
        const boostOptions = document.querySelectorAll('.boost-option');
        const boostStatus = document.getElementById('boost-status');
        const boostBotIdInput = document.getElementById('boost-bot-id');
        const infoPopupTitle = document.getElementById('info-popup-title');
        const infoPopupMessage = document.getElementById('info-popup-message');
        const botDetailPage = document.getElementById('bot-detail-page');
        const backToHomeButton = document.getElementById('back-to-home-button');
        const detailBotName = document.getElementById('detail-bot-name');
        const botDetailContent = document.getElementById('bot-detail-content');
        const commentsList = document.getElementById('comments-list');
        const addCommentForm = document.getElementById('add-comment-form');
        const commentInput = document.getElementById('comment-input');
        const chatPage = document.getElementById('chat-page');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');

        // --- Utility Functions ---
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            num = Number(num);
            if (Math.abs(num) < 1000) return num.toString();
            const suffixes = ['', 'K', 'M', 'B', 'T'];
            let i = 0;
            while (Math.abs(num) >= 1000 && i < suffixes.length - 1) {
                num /= 1000; i++;
            }
            const formattedNum = num.toFixed(1).replace(/\.0$/, '');
            return formattedNum + suffixes[i];
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout); timeout = setTimeout(later, wait);
            };
        }

        // --- Initialization ---
        async function initializeApp() {
            console.log("Initializing App...");
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation(); // Ask user before closing

            // Set theme based on Telegram settings
            setTheme(tg.colorScheme);
            tg.onEvent('themeChanged', () => setTheme(tg.colorScheme));


            // Check if running inside Telegram
            if (!tg.initDataUnsafe?.user?.id) {
            // Use tg.initData for production after backend verification
            // if (!tg.initData) {
                showError("Please open this app inside Telegram.");
                // Optionally disable all interactions
                appDiv.style.pointerEvents = 'none';
                return; // Halt initialization
            }

            currentUser = tg.initDataUnsafe.user;
            console.log("Current User:", currentUser.id, currentUser.username);

            // Initialize Firebase
            try {
                console.log("Initializing Firebase...");
                if (!firebase.apps.length) { // Prevent re-initializing
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.database();
                console.log("Firebase Initialized.");

                // Fetch essential user profile data FIRST
                console.log("Fetching User Profile...");
                await fetchUserProfile(); // Wait for profile load
                console.log("User Profile Loaded.");

                // Setup listeners AFTER profile is loaded
                setupEventListeners();
                listenForBots();
                listenForChatMessages();

                // Hide loading screen and show the default page (Home)
                hideLoadingScreen();
                showPage('home-page', true); // Show home page without transition initially

            } catch (error) {
                console.error("Initialization Error:", error);
                showError(`Initialization failed: ${error.message}`);
            }
        }

        function setTheme(scheme) {
            console.log("Setting theme:", scheme);
            document.body.className = scheme; // Add 'dark' or 'light' class to body
            // Optional: Adjust theme colors if needed via CSS variables based on the class
             tg.setHeaderColor(scheme === 'dark' ? '#1e1e1e' : '#ffffff'); // Example header color change
        }


        function showLoadingScreen() {
            loadingScreen.classList.remove('hidden');
            errorMessage.style.display = 'none';
            loadingScreen.querySelector('.spinner').style.display = 'block';
            loadingScreen.querySelector('p:not(#error-message)').textContent = 'Loading App...';
        }

        function hideLoadingScreen() {
            loadingScreen.classList.add('hidden');
        }

        function showError(message) {
            console.error("ERROR:", message);
            // Ensure loading screen is visible to show the error
            loadingScreen.classList.remove('hidden');
            loadingScreen.querySelector('p:not(#error-message)').textContent = 'Error';
            loadingScreen.querySelector('.spinner').style.display = 'none';
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            // Maybe disable interactions on the rest of the app
            pages.forEach(p => p.style.pointerEvents = 'none');
            document.querySelector('.bottom-nav')?.style.pointerEvents = 'none';
        }

        // --- Data Fetching & Realtime Listeners ---
        async function fetchUserProfile() {
            const userRef = db.ref(`users/${currentUser.id}`);
            try {
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    userProfile = { points: 0, likedBots: {}, lastAdWatch: 0, ...snapshot.val() };
                    if (!userProfile.likedBots || typeof userProfile.likedBots !== 'object') {
                        userProfile.likedBots = {};
                    }
                } else {
                    console.log("Creating new user profile in Firebase for:", currentUser.id);
                    const initialProfile = {
                        id: currentUser.id,
                        firstName: currentUser.first_name || '',
                        lastName: currentUser.last_name || '',
                        username: currentUser.username || `user${currentUser.id}`,
                        points: 0,
                        likedBots: {},
                        lastAdWatch: 0,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    await userRef.set(initialProfile);
                    userProfile = { ...initialProfile, createdAt: Date.now() }; // Simulate timestamp locally
                }
                updateProfileUI(); // Update UI elements
            } catch (error) {
                console.error("Error fetching/creating user profile:", error);
                // Don't halt the entire app, but show a warning
                showInfoPopup("Profile Warning", "Could not load/save profile data. Some features might be limited.");
                // Ensure userProfile has default structure to prevent other errors
                userProfile = { points: 0, likedBots: {}, lastAdWatch: 0 };
                updateProfileUI(); // Update with defaults
            }
        }

        function listenForBots() {
            if (botsListenerRef) botsListenerRef.off(); // Detach previous listener
            botsListenerRef = db.ref('bots'); //.orderByChild('createdAt'); // Consider indexing for performance

            botsListenerRef.on('value', (snapshot) => {
                const fetchedBots = {};
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const botData = childSnapshot.val();
                        if (botData && typeof botData === 'object') {
                            const isActive = botData.active !== undefined ? botData.active : true;
                            // Store all bots needed for profile view, filter for home later
                           fetchedBots[childSnapshot.key] = {
                                id: childSnapshot.key,
                                name: botData.name || 'Unnamed Bot',
                                description: botData.description || '',
                                link: botData.link || '',
                                imageLink: botData.imageLink || null,
                                telegramCommunity: botData.telegramCommunity || null,
                                airdropName: botData.airdropName || null,
                                airdropPoints: botData.airdropPoints || null,
                                active: isActive,
                                submitterId: botData.submitterId || null,
                                submitterUsername: botData.submitterUsername || 'Unknown',
                                createdAt: botData.createdAt || 0,
                                likesCount: botData.likesCount || 0,
                                boostEndDate: botData.boostEndDate || 0,
                            };
                        }
                    });
                }
                allBots = fetchedBots; // Update global cache
                console.log("Bots updated:", Object.keys(allBots).length);

                // Update relevant UI parts
                displayBots(); // Update home page list
                updateMyBotsList(); // Update profile page list
                if(currentOpenBotId && allBots[currentOpenBotId]) {
                    updateBotDetailLikeSection(allBots[currentOpenBotId]); // Update like count if detail view is open
                } else if(currentOpenBotId && !allBots[currentOpenBotId]) {
                    // Handle case where the currently viewed bot was deleted
                    console.warn("Currently viewed bot was deleted:", currentOpenBotId);
                    showInfoPopup("Bot Removed", "The bot you were viewing is no longer available.");
                    showPage('home-page'); // Go back home
                }

            }, (error) => {
                console.error("Error listening for bots:", error);
                botListContainer.innerHTML = '<p class="placeholder" style="color: var(--error-color);">Error loading bots.</p>';
                // Optionally show a more prominent error
            });
        }

        function listenForComments(botId) {
            if (commentsListenerRef) commentsListenerRef.off();
            commentsList.innerHTML = '<p class="placeholder">Loading comments...</p>';
            commentsListenerRef = db.ref(`bots/${botId}/comments`).orderByChild('timestamp').limitToLast(100); // Limit comments loaded

            commentsListenerRef.on('value', (snapshot) => {
                commentsList.innerHTML = ''; // Clear
                if (!snapshot.exists()) {
                    commentsList.innerHTML = '<p class="placeholder">Be the first to comment!</p>';
                    return;
                }
                const botOwnerId = allBots[botId]?.submitterId;
                snapshot.forEach((commentSnapshot) => {
                    const commentData = commentSnapshot.val();
                    if (commentData && commentData.userId && commentData.text) {
                        const isOwner = botOwnerId && commentData.userId === botOwnerId;
                        const commentCard = createCommentCard(commentData, commentSnapshot.key, isOwner);
                        commentsList.appendChild(commentCard); // Add new comments to the end
                    }
                });
                // Optional: Scroll to bottom of comments if needed
                // commentsList.scrollTop = commentsList.scrollHeight;
            }, (error) => {
                console.error(`Error listening for comments on bot ${botId}:`, error);
                commentsList.innerHTML = '<p class="placeholder" style="color: var(--error-color);">Error loading comments.</p>';
            });
        }

        function listenForChatMessages() {
            if (chatListenerRef) chatListenerRef.off();
            chatMessagesDiv.innerHTML = '<p class="placeholder">Loading messages...</p>';
            chatListenerRef = db.ref('chatMessages').orderByChild('timestamp').limitToLast(CHAT_MESSAGE_LIMIT);

            chatListenerRef.on('child_added', (msgSnapshot) => { // Use child_added for efficiency
                 // Remove placeholder if it exists
                const placeholder = chatMessagesDiv.querySelector('.placeholder');
                if(placeholder) placeholder.remove();

                const msgData = msgSnapshot.val();
                if (msgData && msgData.userId && msgData.text && msgData.timestamp) {
                    const messageElement = createChatMessageElement(msgData);
                    chatMessagesDiv.prepend(messageElement); // Add to top because of column-reverse
                    // Trim older messages if list exceeds limit (simple trimming)
                    while (chatMessagesDiv.children.length > CHAT_MESSAGE_LIMIT + 10) { // Keep a buffer
                        chatMessagesDiv.lastChild.remove();
                    }
                }
            }, (error) => {
                console.error("Error listening for chat messages:", error);
                 // Avoid clearing messages if listener fails, just show error somewhere
                 if(chatMessagesDiv.children.length === 0) { // Only show error if list is empty
                     chatMessagesDiv.innerHTML = '<p class="placeholder" style="color: var(--error-color);">Error loading chat.</p>';
                 } else {
                     showInfoPopup("Chat Error", "Could not load new messages.")
                 }
            });
        }

        // --- UI Updates ---
        function showPage(pageId, instant = false) {
            // Detach listeners for pages being left
            if (currentOpenBotId && pageId !== 'bot-detail-page' && commentsListenerRef) {
                console.log("Detaching comments listener for bot:", currentOpenBotId);
                commentsListenerRef.off();
                commentsListenerRef = null;
                currentOpenBotId = null;
            }

            let foundPage = false;
            pages.forEach(page => {
                const isActive = page.id === pageId;
                if (isActive) {
                    foundPage = true;
                     // Only apply transition if not instant
                    if (!instant) {
                         page.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                    } else {
                         page.style.transition = 'none'; // No transition for initial load
                    }
                    page.classList.add('active-page');
                    if (page.id !== 'chat-page') {
                        page.scrollTop = 0; // Reset scroll for non-chat pages
                    }
                    // Restore transition after instant show
                    if(instant) setTimeout(() => page.style.transition = '', 50);
                } else {
                    page.classList.remove('active-page');
                }
            });

             if (!foundPage) {
                console.error(`Page with ID "${pageId}" not found!`);
                showPage('home-page'); // Default to home page if target not found
                return;
            }


            // Update nav buttons
            navButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.page === pageId);
            });
            addBotNavButton.classList.remove('active'); // Deactivate add button visually

            // Page-specific actions
            if (pageId === 'profile-page') {
                updateProfileUI(); // Ensure profile data is fresh
                updateMyBotsList();
            } else if (pageId === 'home-page') {
                 displayBots(); // Ensure bot list is filtered/sorted correctly
                 //searchInput.value = ''; // Optionally clear search
            } else if (pageId === 'chat-page') {
                scrollToChatBottom(); // Scroll down when entering chat
            }
            // Bot detail page logic (listener attachment) happens in showBotDetails
        }

        function updateProfileUI() {
            if (!currentUser) return;
            profileName.textContent = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || 'No Name';
            profileUsername.textContent = currentUser.username ? `@${currentUser.username}` : 'Not set';
            profileChatId.textContent = currentUser.id;
            profilePoints.textContent = formatNumber(userProfile.points);
        }

        function displayBots() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const activeTab = document.querySelector('.tab-button.active')?.dataset.tab || 'all';

            // Filter active bots for home page display
            let filteredBots = Object.values(allBots).filter(bot => bot.active === true && (
                !searchTerm || // Show all if no search term
                (bot.name?.toLowerCase() || '').includes(searchTerm) ||
                (bot.description?.toLowerCase() || '').includes(searchTerm)
            ));

            // Sort (Boosted first, then by tab criteria)
            const now = Date.now();
            currentBotList = filteredBots.sort((a, b) => {
                const aIsBoosted = a.boostEndDate && a.boostEndDate > now;
                const bIsBoosted = b.boostEndDate && b.boostEndDate > now;

                if (aIsBoosted !== bIsBoosted) return aIsBoosted ? -1 : 1;

                // Sort by criteria if boost status is the same
                if (activeTab === 'trending') {
                    // Simple trending: Likes + Recency (within last 7 days)
                    const weekAgo = now - 7 * 24 * 60 * 60 * 1000;
                    const scoreA = (a.likesCount || 0) + (a.createdAt > weekAgo ? 5 : 0); // Add bonus for recent
                    const scoreB = (b.likesCount || 0) + (b.createdAt > weekAgo ? 5 : 0);
                     if(scoreA !== scoreB) return scoreB - scoreA;
                    return (b.createdAt || 0) - (a.createdAt || 0); // Fallback sort by newest
                } else if (activeTab === 'top-liked') {
                    return (b.likesCount || 0) - (a.likesCount || 0);
                } else { // 'all'
                    return (b.createdAt || 0) - (a.createdAt || 0);
                }
            });

            // Render
            botListContainer.innerHTML = ''; // Clear previous list
            if (currentBotList.length === 0) {
                botListContainer.innerHTML = `<p class="placeholder">No bots found${searchTerm ? ' matching "' + searchTerm + '"' : ''}.</p>`;
            } else {
                const fragment = document.createDocumentFragment();
                currentBotList.forEach(bot => {
                    const card = createBotCard(bot, 'home');
                    fragment.appendChild(card);
                });
                botListContainer.appendChild(fragment); // Append all at once
            }
        }

        function updateMyBotsList() {
            if (!currentUser) return;
            myBotsList.innerHTML = '';
            const userBots = Object.values(allBots)
                .filter(bot => bot.submitterId === currentUser.id)
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            if (userBots.length === 0) {
                myBotsList.innerHTML = '<p class="placeholder">You haven\'t added any bots yet.</p>';
            } else {
                 const fragment = document.createDocumentFragment();
                userBots.forEach(bot => {
                    const card = createBotCard(bot, 'profile');
                     fragment.appendChild(card);
                });
                 myBotsList.appendChild(fragment);
            }
        }

        function createBotCard(bot, context = 'home') {
            const card = document.createElement('div');
            card.className = 'bot-card card-style';
            card.dataset.botId = bot.id;

            const isLiked = userProfile.likedBots && userProfile.likedBots[bot.id];
            const likeIcon = isLiked ? 'favorite' : 'favorite_border';
            const likeButtonClass = isLiked ? 'like-button liked' : 'like-button';
            const now = Date.now();
            const isBoosted = bot.boostEndDate && bot.boostEndDate > now;

            // Default image placeholder
            const imageSrc = bot.imageLink || `https://ui-avatars.com/api/?name=${encodeURIComponent(bot.name[0] || '?')}&background=444&color=fff&size=55&rounded=true`;

            card.innerHTML = `
                <img src="${escapeHTML(imageSrc)}" alt="Bot Icon" class="bot-image" loading="lazy" onerror="this.src='https://ui-avatars.com/api/?name=?&background=444&color=fff&size=55&rounded=true'; this.onerror=null;">
                <div class="bot-info">
                    <h3>
                        ${escapeHTML(bot.name)}
                        ${isBoosted ? '<span class="material-symbols-outlined" title="Boosted">rocket_launch</span>' : ''}
                        ${bot.active === false ? '<span class="inactive-tag" title="Inactive">Inactive</span>': ''}
                    </h3>
                    <p class="description">${escapeHTML(bot.description) || 'No description.'}</p>
                    <div class="bot-meta">
                        <span class="likes">
                            <button class="${likeButtonClass} icon-button" data-bot-id="${bot.id}" title="${isLiked ? 'Unlike' : 'Like'} Bot">
                                <span class="material-symbols-outlined">${likeIcon}</span>
                            </button>
                            <span class="like-count">${formatNumber(bot.likesCount)}</span>
                        </span>
                        <span class="submitter" title="Submitted by @${escapeHTML(bot.submitterUsername)}">
                            <span class="material-symbols-outlined">person</span>
                            <span>@${escapeHTML(bot.submitterUsername)}</span>
                        </span>
                    </div>
                </div>
                ${context === 'profile' ? `
                    <div class="bot-actions">
                        <button class="edit-bot-button icon-button" data-bot-id="${bot.id}" title="Edit Bot"><span class="material-symbols-outlined">edit</span></button>
                        <button class="boost-bot-button icon-button" data-bot-id="${bot.id}" title="Boost Bot"><span class="material-symbols-outlined">rocket_launch</span></button>
                    </div>
                ` : ''}
            `;

            // Event Listeners
            const likeButton = card.querySelector('.like-button');
            if (likeButton) {
                likeButton.addEventListener('click', (e) => { e.stopPropagation(); handleLikeBot(bot.id); });
            }
            if (context === 'home') {
                 card.addEventListener('click', () => showBotDetails(bot.id));
            }
             if (context === 'profile') {
                 const editButton = card.querySelector('.edit-bot-button');
                 const boostButton = card.querySelector('.boost-bot-button');
                 if (editButton) editButton.addEventListener('click', (e) => { e.stopPropagation(); handleEditBot(bot.id); });
                 if (boostButton) boostButton.addEventListener('click', (e) => { e.stopPropagation(); handleBoostBot(bot.id); });
            }
            return card;
        }

        function showBotDetails(botId) {
            const bot = allBots[botId];
            if (!bot) { showInfoPopup("Error", "Bot details not found."); return; }

             // If already showing this bot, don't re-render everything unnecessarily
             if (currentOpenBotId === botId && document.getElementById('bot-detail-page').classList.contains('active-page')) {
                 console.log("Bot details already visible for:", botId);
                 // Maybe just ensure scroll position?
                 botDetailPage.scrollTop = 0;
                 return;
             }

            currentOpenBotId = botId;
            console.log("Showing details for bot:", botId);

            detailBotName.textContent = bot.name;
             const imageSrc = bot.imageLink || `https://ui-avatars.com/api/?name=${encodeURIComponent(bot.name[0] || '?')}&background=444&color=fff&size=100&rounded=true`;

            botDetailContent.innerHTML = `
                <img src="${escapeHTML(imageSrc)}" alt="Bot Icon" onerror="this.style.display='none';">
                <p id="detail-description">${escapeHTML(bot.description) || 'No description available.'}</p>
                <div id="detail-meta">
                    <p><strong>Link:</strong> <span><a href="${escapeHTML(bot.link)}" target="_blank" rel="noopener noreferrer">${escapeHTML(bot.link)}</a></span></p>
                    ${bot.telegramCommunity ? `<p><strong>Community:</strong> <span><a href="${escapeHTML(bot.telegramCommunity)}" target="_blank" rel="noopener noreferrer">${escapeHTML(bot.telegramCommunity)}</a></span></p>` : ''}
                    ${bot.airdropName ? `<p><strong>Airdrop:</strong> <span>${escapeHTML(bot.airdropName)} ${bot.airdropPoints ? `(<span class="points-display">${formatNumber(bot.airdropPoints)}</span>)` : ''}</span></p>` : ''}
                    <p><strong>Submitted by:</strong> <span>@${escapeHTML(bot.submitterUsername)}</span></p>
                    <p><strong>Submitted on:</strong> <span>${new Date(bot.createdAt || 0).toLocaleDateString()}</span></p>
                </div>
                <div id="detail-like-section">
                    <button class="button" id="detail-like-button" data-bot-id="${bot.id}">
                        <span class="material-symbols-outlined"></span> <span class="like-text">Like</span>
                    </button>
                    <span id="detail-like-count">${formatNumber(bot.likesCount)} Likes</span>
                </div>
            `;
            updateBotDetailLikeSection(bot); // Set initial like button state

            // Add listener AFTER innerHTML is set
            const detailLikeButton = botDetailContent.querySelector('#detail-like-button');
            if (detailLikeButton) {
                detailLikeButton.addEventListener('click', (e) => { e.stopPropagation(); handleLikeBot(bot.id); });
            }

            showPage('bot-detail-page');
            listenForComments(botId); // Start listening for comments
            commentInput.value = ''; // Clear comment input
        }

        function updateBotDetailLikeSection(botData) {
            if (!botData || !botDetailContent || currentOpenBotId !== botData.id) return;

            const isLiked = userProfile.likedBots && userProfile.likedBots[botData.id];
            const likeButton = botDetailContent.querySelector('#detail-like-button');
            const likeCountSpan = botDetailContent.querySelector('#detail-like-count');

            if (likeButton) {
                likeButton.classList.toggle('liked', isLiked); // Add/remove 'liked' class
                // Update background based on class using CSS ':not(.liked)' selector if needed
                likeButton.querySelector('.material-symbols-outlined').textContent = isLiked ? 'favorite' : 'favorite_border';
                likeButton.querySelector('.like-text').textContent = isLiked ? 'Unlike' : 'Like';
                likeButton.title = isLiked ? 'Unlike Bot' : 'Like Bot';
            }
            if (likeCountSpan) {
                likeCountSpan.textContent = `${formatNumber(botData.likesCount || 0)} Likes`;
            }
        }

        function updateLikeButtonUI(botId, isLiked, newCount) {
             if (!botId) return;
            const formattedCount = formatNumber(newCount);

            // Update cards on home/profile lists
            document.querySelectorAll(`.bot-card[data-bot-id="${botId}"]`).forEach(card => {
                const likeButton = card.querySelector('.like-button');
                const countSpan = card.querySelector('.like-count');
                if (likeButton) {
                    likeButton.classList.toggle('liked', isLiked);
                    likeButton.querySelector('.material-symbols-outlined').textContent = isLiked ? 'favorite' : 'favorite_border';
                    likeButton.title = isLiked ? 'Unlike Bot' : 'Like Bot';
                }
                if (countSpan) countSpan.textContent = formattedCount;
            });

            // Update detail page if open
            if (currentOpenBotId === botId && allBots[botId]) {
                 // Update local bot data cache first (important!)
                 allBots[botId].likesCount = newCount;
                updateBotDetailLikeSection(allBots[botId]);
            }
        }

        // --- Comments UI ---
        function createCommentCard(commentData, commentId, isOwner) {
            const card = document.createElement('div');
            card.className = 'comment-card';
            card.dataset.commentId = commentId;

            const timestamp = commentData.timestamp ? new Date(commentData.timestamp).toLocaleString([], {dateStyle: 'short', timeStyle: 'short'}) : 'Sending...';
            const authorName = escapeHTML(commentData.firstName || commentData.username); // Prefer first name

            card.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author" title="@${escapeHTML(commentData.username || 'Unknown')}">
                        ${isOwner ? '<span class="material-symbols-outlined" title="Bot Uploader">verified_user</span>' : ''}
                        ${authorName}
                    </span>
                    <span class="comment-timestamp">${timestamp}</span>
                </div>
                <p class="comment-text">${escapeHTML(commentData.text)}</p>
                <!-- Reply button placeholder -->
            `;
            return card;
        }

        // --- Chat UI ---
        function createChatMessageElement(msgData) {
            const messageDiv = document.createElement('div');
            const isSent = msgData.userId === currentUser.id;
            messageDiv.classList.add('chat-message', isSent ? 'sent' : 'received');

            const timestamp = msgData.timestamp ? new Date(msgData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const safeText = escapeHTML(msgData.text);
            const senderName = escapeHTML(msgData.firstName || msgData.username || 'User');

            messageDiv.innerHTML = `
                ${!isSent ? `<span class="message-sender" title="@${escapeHTML(msgData.username || 'Unknown')}">@${senderName}</span>` : ''}
                <span class="message-text">${safeText}</span>
                <span class="message-timestamp">${timestamp}</span>
            `;
            return messageDiv;
        }

        function scrollToChatBottom() {
            // Needs slight delay sometimes for elements to render
            requestAnimationFrame(() => {
                 if (chatMessagesContainer) { // Check if element exists
                     chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                 }
            });
        }

        // --- Actions & Event Handlers ---
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            // Navigation
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;
                    if (pageId && !button.classList.contains('active')) { // Only switch if not active
                        showPage(pageId);
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });
            });
            addBotNavButton.addEventListener('click', () => { openAddBotPopup(); tg.HapticFeedback.impactOccurred('light'); });
            backToHomeButton.addEventListener('click', () => showPage('home-page'));

            // Search & Tabs
            searchInput.addEventListener('input', debounce(displayBots, 300));
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (!button.classList.contains('active')) {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        displayBots();
                    }
                });
            });

            // Popups
            closePopupButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const popupId = button.dataset.popup || button.closest('.popup')?.id;
                    if (popupId) closePopup(popupId);
                });
            });

            // Forms
            addBotForm.addEventListener('submit', handleAddBotSubmit);
            addCommentForm.addEventListener('submit', handleAddComment);
            chatForm.addEventListener('submit', handleSendMessage);

            // Ads Buttons
            profileEarnAdsButton.addEventListener('click', handleEarnAdsClick);
            homeEarnAdsButton.addEventListener('click', handleEarnAdsClick);

            // Boost Actions
            boostOptions.forEach(button => {
                button.addEventListener('click', handleBoostSelection);
            });
             console.log("Event listeners setup complete.");
        }

        function openPopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) {
                popup.style.display = 'flex';
                setTimeout(() => popup.classList.add('active-popup'), 10); // Delay for transition
            }
        }

        function closePopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup && popup.classList.contains('active-popup')) { // Only close if open
                popup.classList.remove('active-popup');
                const handleTransitionEnd = () => {
                    popup.style.display = 'none';
                    popup.removeEventListener('transitionend', handleTransitionEnd);
                    // Reset specific popups after hiding
                    resetPopupForms(popupId);
                };
                popup.addEventListener('transitionend', handleTransitionEnd);
                 // Fallback if transition doesn't fire (e.g., element removed)
                 setTimeout(() => {
                     if (popup.style.display !== 'none') { // Check if already hidden
                         popup.style.display = 'none';
                          resetPopupForms(popupId);
                     }
                 }, 350); // Slightly longer than transition
            }
        }

         function resetPopupForms(popupId) {
             if (popupId === 'add-bot-popup') {
                addBotForm.reset();
                document.getElementById('edit-bot-id').value = '';
                document.getElementById('submit-bot-button').textContent = 'Add Bot';
                addBotPopup.querySelector('h2').textContent = 'Add New Bot';
            } else if (popupId === 'boost-popup') {
                boostStatus.textContent = '';
                boostBotIdInput.value = '';
                // Re-enable options and update text (might need user points check)
                boostOptions.forEach(btn => {
                    const cost = parseInt(btn.dataset.cost);
                    btn.disabled = userProfile.points < cost;
                     const duration = btn.dataset.duration;
                     btn.innerHTML = `Boost ${duration} Day${duration > 1 ? 's': ''} (<span class="points-display">${formatNumber(cost)}</span>)`;
                });
            }
             // No reset needed for info popup usually
        }

        function showInfoPopup(title, message) {
            infoPopupTitle.textContent = title;
            infoPopupMessage.textContent = message;
            openPopup('info-popup');
        }

        // --- Add/Edit Bot Logic ---
        function openAddBotPopup(editBotData = null) {
            addBotForm.reset(); // Start fresh
            const submitButton = document.getElementById('submit-bot-button');
            const editBotIdInput = document.getElementById('edit-bot-id');

            if (editBotData) { // Editing existing bot
                console.log("Opening edit popup for:", editBotData.id);
                document.getElementById('bot-name').value = editBotData.name || '';
                document.getElementById('bot-description').value = editBotData.description || '';
                document.getElementById('bot-link').value = editBotData.link || '';
                document.getElementById('bot-image').value = editBotData.imageLink || '';
                document.getElementById('bot-community').value = editBotData.telegramCommunity || '';
                document.getElementById('bot-airdrop-name').value = editBotData.airdropName || '';
                document.getElementById('bot-airdrop-points').value = editBotData.airdropPoints || '';
                document.getElementById('bot-active').checked = editBotData.active; // Should exist
                editBotIdInput.value = editBotData.id;
                submitButton.textContent = 'Update Bot';
                addBotPopup.querySelector('h2').textContent = 'Edit Bot';
            } else { // Adding new bot
                 console.log("Opening add new bot popup");
                editBotIdInput.value = '';
                submitButton.textContent = 'Add Bot';
                addBotPopup.querySelector('h2').textContent = 'Add New Bot';
                document.getElementById('bot-active').checked = true; // Default to active
            }
            openPopup('add-bot-popup');
        }

        async function handleAddBotSubmit(event) {
            event.preventDefault();
            if (!currentUser || !db) {
                showInfoPopup("Error", "Not connected. Please restart the app.");
                return;
            }

            const submitButton = document.getElementById('submit-bot-button');
            submitButton.disabled = true;
            const originalButtonText = submitButton.textContent;
            submitButton.innerHTML = `<div class="spinner" style="width: 18px; height: 18px; border-width: 2px; margin: 0 auto;"></div> Saving...`;

            const botIdToEdit = document.getElementById('edit-bot-id').value;
            const airdropPointsInput = document.getElementById('bot-airdrop-points').value;
            const botLink = document.getElementById('bot-link').value.trim();

            // Basic link validation
             if (!botLink.match(/^https:\/\/t\.me\/[a-zA-Z0-9_]+$/)) {
                 showInfoPopup("Validation Error", "Invalid Bot Link. Must be like https://t.me/YourBotUsername (only letters, numbers, underscores allowed in username).");
                 submitButton.disabled = false;
                 submitButton.innerHTML = originalButtonText;
                 return;
            }

            const botData = {
                name: document.getElementById('bot-name').value.trim(),
                description: document.getElementById('bot-description').value.trim(),
                link: botLink,
                imageLink: document.getElementById('bot-image').value.trim() || null,
                telegramCommunity: document.getElementById('bot-community').value.trim() || null,
                airdropName: document.getElementById('bot-airdrop-name').value.trim() || null,
                airdropPoints: airdropPointsInput ? parseInt(airdropPointsInput, 10) : null,
                active: document.getElementById('bot-active').checked,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            // Validate required fields
            if (!botData.name || !botData.description) {
                showInfoPopup("Validation Error", "Please fill in Bot Name and Description.");
                 submitButton.disabled = false;
                 submitButton.innerHTML = originalButtonText;
                 return;
            }
             if (botData.airdropPoints !== null && isNaN(botData.airdropPoints)) {
                showInfoPopup("Validation Error", "Airdrop Points must be a valid number if entered.");
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                 return;
            }

            try {
                if (botIdToEdit) { // --- Update ---
                     const botToEditData = allBots[botIdToEdit];
                     if (!botToEditData || botToEditData.submitterId !== currentUser.id) {
                         throw new Error("Permission denied or bot not found.");
                     }
                     // Add necessary fields that don't change on update
                      botData.submitterId = botToEditData.submitterId;
                      botData.submitterUsername = botToEditData.submitterUsername;
                      botData.createdAt = botToEditData.createdAt; // Preserve original creation time
                      botData.likesCount = botToEditData.likesCount; // Keep existing likes
                      botData.boostEndDate = botToEditData.boostEndDate; // Keep existing boost

                     const botRef = db.ref(`bots/${botIdToEdit}`);
                     await botRef.set(botData); // Use set to overwrite completely with validated data
                     showInfoPopup("Success", "Bot updated successfully!");
                } else { // --- Add New ---
                    botData.submitterId = currentUser.id;
                    botData.submitterUsername = currentUser.username || `user${currentUser.id}`;
                    botData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                    botData.likesCount = 0;
                    botData.boostEndDate = 0;
                    const newBotRef = db.ref('bots').push();
                    await newBotRef.set(botData);
                    showInfoPopup("Success", "Bot added successfully!");
                }
                closePopup('add-bot-popup');
                tg.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                console.error("Error saving bot:", error);
                showInfoPopup("Error", `Failed to save bot: ${error.message}`);
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                 // Re-enable button regardless of success/failure, text reset in closePopup
                 submitButton.disabled = false;
                 submitButton.innerHTML = originalButtonText; // Restore text immediately
            }
        }

        function handleEditBot(botId) {
            const botToEdit = allBots[botId];
            if (botToEdit && botToEdit.submitterId === currentUser.id) {
                openAddBotPopup(botToEdit);
            } else {
                showInfoPopup("Permission Denied", "You can only edit your own bots.");
            }
        }

        // --- Like Logic ---
        async function handleLikeBot(botId) {
            if (!currentUser || !db || !botId || !allBots[botId]) return;

            const botRef = db.ref(`bots/${botId}`);
            const userLikesRef = db.ref(`users/${currentUser.id}/likedBots/${botId}`);
            const botData = allBots[botId];

            tg.HapticFeedback.impactOccurred('medium');

            const currentlyLiked = userProfile.likedBots && userProfile.likedBots[botId];
            const newLikedState = !currentlyLiked;

            // --- Optimistic UI Update ---
            const estimatedNewCount = (botData.likesCount || 0) + (newLikedState ? 1 : -1);
             if (!userProfile.likedBots) userProfile.likedBots = {}; // Ensure object exists
             if (newLikedState) {
                userProfile.likedBots[botId] = true;
            } else {
                 delete userProfile.likedBots[botId];
            }
            updateLikeButtonUI(botId, newLikedState, Math.max(0, estimatedNewCount)); // Update UI immediately

            try {
                // Update Like Count (Transaction)
                const countUpdate = await botRef.child('likesCount').transaction(currentCount => {
                    const count = currentCount || 0;
                    return newLikedState ? count + 1 : Math.max(0, count - 1);
                });

                if (!countUpdate.committed) throw new Error("Like count transaction failed.");
                const finalLikesCount = countUpdate.snapshot.val();

                // Update User's Liked List
                await userLikesRef.set(newLikedState ? true : null);

                // Award points to submitter (ONLY on successful LIKE, not unlike)
                if (newLikedState && botData.submitterId && botData.submitterId !== currentUser.id) {
                    const submitterPointsRef = db.ref(`users/${botData.submitterId}/points`);
                    await submitterPointsRef.transaction(currentPoints => (currentPoints || 0) + LIKE_REWARD_POINTS);
                    console.log(`Awarded ${LIKE_REWARD_POINTS} points to user ${botData.submitterId}`);
                }

                // --- Final UI Update (with actual count) ---
                // Already done optimistically, but good to confirm with final count if needed elsewhere
                // updateLikeButtonUI(botId, newLikedState, finalLikesCount); // Redundant if optimistic is correct

                console.log(`Like/Unlike success for bot ${botId}. New count: ${finalLikesCount}`);

            } catch (error) {
                console.error("Error liking/unliking bot:", error);
                showInfoPopup("Like Error", "Update failed. Please try again.");
                // --- Revert Optimistic Update ---
                 if (currentlyLiked) { // If it was liked before error
                     userProfile.likedBots[botId] = true;
                 } else { // If it wasn't liked
                     delete userProfile.likedBots[botId];
                 }
                 updateLikeButtonUI(botId, currentlyLiked, botData.likesCount); // Revert UI to original state
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // --- Points & Ads Logic ---
        async function updateUserPoints(pointsToAdd) {
             // Basic check - ensure user profile is loaded
             if (userProfile === null || typeof userProfile.points !== 'number') {
                 console.error("Cannot update points, user profile not loaded or invalid.");
                 return false;
             }
            if (!currentUser || !db || pointsToAdd === 0 || isNaN(pointsToAdd)) return false;

            const userPointsRef = db.ref(`users/${currentUser.id}/points`);
            try {
                const result = await userPointsRef.transaction(currentPoints => {
                    // Handle potential null value from Firebase during transaction
                     const basePoints = (typeof currentPoints === 'number') ? currentPoints : (userProfile.points || 0); // Fallback to local cache if null
                     const newPoints = basePoints + pointsToAdd;
                    return Math.max(0, newPoints); // Ensure points don't go below zero
                });

                if (result.committed) {
                    userProfile.points = result.snapshot.val(); // Update local cache
                    updateProfileUI(); // Update display
                    console.log(`Points updated by ${pointsToAdd}. New total: ${userProfile.points}`);
                    return true;
                } else {
                    console.warn("Points transaction aborted.");
                    return false;
                }
            } catch (error) {
                console.error("Error updating points transaction:", error);
                showInfoPopup("Points Error", "Failed to update points balance.");
                return false;
            }
        }

        function handleEarnAdsClick(event) {
            const button = event.target.closest('button');
            if (!button || button.disabled) return;

            const now = Date.now();
            const lastWatch = userProfile.lastAdWatch || 0;

            if (now - lastWatch < AD_COOLDOWN_MS) {
                const remaining = Math.ceil((AD_COOLDOWN_MS - (now - lastWatch)) / 1000);
                showInfoPopup("Cooldown", `Please wait ${remaining}s for the next ad.`);
                return;
            }
            // Check if Ad SDK function exists
            if (typeof show_9263144 !== 'function') {
                showInfoPopup("Ad Error", "Ad system unavailable. Try again later.");
                return;
            }

            button.disabled = true;
            const originalContent = button.innerHTML;
             button.innerHTML = `<div class="spinner" style="width: 18px; height: 18px; border-width: 2px; margin: 0 auto;"></div>`;
            showInfoPopup("Loading Ad", "Please wait..."); // More neutral message

             console.log("Requesting ad...");
             tg.HapticFeedback.impactOccurred('light');

            show_9263144().then(async () => {
                console.log("Ad watched successfully.");
                closePopup('info-popup');
                 showInfoPopup("Success!", `Ad reward! +${formatNumber(AD_REWARD_POINTS)} points.`);
                tg.HapticFeedback.notificationOccurred('success');

                 // Update last watch time FIRST
                 try {
                    await db.ref(`users/${currentUser.id}/lastAdWatch`).set(firebase.database.ServerValue.TIMESTAMP);
                    userProfile.lastAdWatch = Date.now(); // Update local cache immediately
                 } catch (timeError) {
                     console.error("Failed to update ad watch time:", timeError);
                     // Still try to award points
                 }
                 // Award points
                 await updateUserPoints(AD_REWARD_POINTS);

            }).catch((error) => {
                console.warn("Ad SDK error or ad closed:", error);
                closePopup('info-popup');
                 showInfoPopup("Ad Not Completed", "No points awarded this time.");
                tg.HapticFeedback.notificationOccurred('warning');
            }).finally(() => {
                button.disabled = false;
                button.innerHTML = originalContent;
            });
        }

        // --- Boost Logic ---
        function handleBoostBot(botId) {
            const bot = allBots[botId];
            if (!bot || bot.submitterId !== currentUser.id) {
                showInfoPopup("Error", "Bot not found or permission denied.");
                return;
            }
            boostBotIdInput.value = botId;
            boostStatus.textContent = '';
            // Update options based on current points
            boostOptions.forEach(btn => {
                 const cost = parseInt(btn.dataset.cost);
                 btn.disabled = userProfile.points < cost;
                 const duration = btn.dataset.duration;
                 btn.innerHTML = `Boost ${duration} Day${duration > 1 ? 's': ''} (<span class="points-display">${formatNumber(cost)}</span>)`;
            });
            openPopup('boost-popup');
        }

        async function handleBoostSelection(event) {
            const button = event.target.closest('.boost-option');
            if (!button) return;
            const botId = boostBotIdInput.value;
            const durationDays = parseInt(button.dataset.duration);
            const cost = parseInt(button.dataset.cost);

            if (!botId || !durationDays || !cost || !allBots[botId]) {
                boostStatus.textContent = 'Error: Invalid selection.'; return;
            }
            if (userProfile.points < cost) {
                boostStatus.textContent = 'Error: Not enough points.'; return;
            }

            boostOptions.forEach(btn => btn.disabled = true);
            boostStatus.textContent = 'Processing...';
            tg.HapticFeedback.impactOccurred('heavy');

            // 1. Deduct points
            const pointsDeducted = await updateUserPoints(-cost);
            if (!pointsDeducted) {
                boostStatus.textContent = 'Error: Failed to deduct points.';
                 // Re-enable relevant buttons after failure
                 boostOptions.forEach(btn => btn.disabled = userProfile.points < parseInt(btn.dataset.cost));
                return;
            }

            // 2. Set boost end date
            const now = Date.now();
            const currentBoostEnd = allBots[botId].boostEndDate || 0;
            const boostStartDate = Math.max(now, currentBoostEnd);
            const newBoostEndDate = boostStartDate + (durationDays * 24 * 60 * 60 * 1000);

            try {
                await db.ref(`bots/${botId}/boostEndDate`).set(newBoostEndDate);
                // Update local cache immediately
                if(allBots[botId]) allBots[botId].boostEndDate = newBoostEndDate;

                boostStatus.textContent = `Success! Bot boosted for ${durationDays} day(s).`;
                tg.HapticFeedback.notificationOccurred('success');
                displayBots(); updateMyBotsList(); // Refresh lists

                setTimeout(() => closePopup('boost-popup'), 2500);
            } catch (error) {
                console.error("Error setting boost end date:", error);
                boostStatus.textContent = 'Points deducted, but failed to update boost. Contact support.';
                // !!! CRITICAL: Implement robust point refund logic here in production !!!
                tg.HapticFeedback.notificationOccurred('error');
                 // Consider attempting refund: await updateUserPoints(cost);
            }
             // Buttons remain disabled until popup is closed/reset
        }

        // --- Comment Handling ---
        async function handleAddComment(event) {
            event.preventDefault();
            const text = commentInput.value.trim();
            if (!text || !currentOpenBotId || !currentUser || !db) return;

            const commentButton = addCommentForm.querySelector('button[type="submit"]');
            commentButton.disabled = true;
            const originalButtonHTML = commentButton.innerHTML;
             commentButton.innerHTML = `<div class="spinner" style="width: 18px; height: 18px; border-width: 2px; margin: 0 auto;"></div> Posting...`;

            const botOwnerId = allBots[currentOpenBotId]?.submitterId;
            const isOwnerReply = !!botOwnerId && botOwnerId === currentUser.id; // Ensure boolean

            const commentData = {
                userId: currentUser.id,
                username: currentUser.username || `user${currentUser.id}`,
                firstName: currentUser.first_name || '',
                text: text.substring(0, 500), // Limit comment length
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                isOwnerComment: isOwnerReply
            };

            try {
                await db.ref(`bots/${currentOpenBotId}/comments`).push(commentData);
                commentInput.value = ''; // Clear input
                tg.HapticFeedback.notificationOccurred('success');
                // Listener will add the comment to the UI
            } catch (error) {
                console.error("Error posting comment:", error);
                showInfoPopup("Comment Error", "Failed to post comment.");
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                commentButton.disabled = false;
                commentButton.innerHTML = originalButtonHTML;
            }
        }

        // --- Chat Message Handling ---
        async function handleSendMessage(event) {
            event.preventDefault();
            const text = chatInput.value.trim();
            if (!text || !currentUser || !db) return;

            const sendButton = chatForm.querySelector('button[type="submit"]');
             if(sendButton.disabled) return; // Prevent double sending

            sendButton.disabled = true; // Disable temporarily

            const messageData = {
                userId: currentUser.id,
                username: currentUser.username || `user${currentUser.id}`,
                firstName: currentUser.first_name || '',
                text: text.substring(0, 500), // Limit message length
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // Add message optimistically to UI? Maybe not needed with listener.
                await db.ref('chatMessages').push(messageData);
                chatInput.value = ''; // Clear input
                // Listener will add it, and CSS will handle position
            } catch (error) {
                console.error("Error sending chat message:", error);
                showInfoPopup("Chat Error", "Failed to send message.");
                 sendButton.disabled = false; // Re-enable on error
            } finally {
                 // Re-enable after a short delay to prevent spamming, unless error occurred
                  if (!sendButton.disabled) { // If not already re-enabled by error
                     setTimeout(() => { sendButton.disabled = false; }, 300);
                 }
            }
        }

        // --- Start the App ---
        // Use DOMContentLoaded to ensure HTML is parsed before running script
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
